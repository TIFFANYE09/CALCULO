<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Derivada paso a paso</title>

<!-- MathJax para f√≥rmulas -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<!-- Plotly para gr√°ficas -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<!-- math.js para c√°lculos -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h1 { text-align: center; }
input, button { padding: 8px; margin: 5px; }
.resultado { background: #f4f4f4; padding: 15px; border-radius: 8px; margin-top: 15px; }
table { border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
</style>
</head>
<body>

<h1>üìò Derivada usando la f√≥rmula del l√≠mite</h1>
<p>Introduce la funci√≥n \(f(x)\):</p>
<input type="text" id="funcion" value="x^2 + 3*x + 2" size="30">
<p>Introduce el punto \(x_0\) para el ejemplo num√©rico:</p>
<input type="number" id="x0" value="2" step="any">
<button onclick="calcular()">Calcular derivada</button>

<div class="resultado" id="explicacion"></div>
<div class="resultado" id="tablaNumerica"></div>
<div id="grafica" style="width:100%;height:500px;"></div>

<script>
function calcular() {
    const funcionStr = document.getElementById("funcion").value;
    const x0 = parseFloat(document.getElementById("x0").value);

    try {
        const parser = math.parser();
        parser.evaluate(`f(x) = ${funcionStr}`);

        let pasos = "";

        // Paso 1: F√≥rmula
        pasos += `<b>1Ô∏è‚É£ F√≥rmula general:</b><br>`;
        pasos += `\\[
        f'(x) = \\lim_{h \\to 0} \\frac{f(x+h) - f(x)}{h}
        \\]<br><br>`;

        // Paso 2: Sustituci√≥n
        const f_xh_str = funcionStr.replace(/x/g, "(x+h)");
        pasos += `<b>2Ô∏è‚É£ Sustituimos f(x):</b><br>`;
        pasos += `\\[
        f'(x) = \\lim_{h \\to 0} \\frac{${f_xh_str} - (${funcionStr})}{h}
        \\]<br><br>`;

        // Paso 3: Simplificar numerador
        const exprOriginal = math.parse(funcionStr);
        const exprXh = math.parse(f_xh_str);
        const numerador = math.simplify(`(${exprXh}) - (${exprOriginal})`);
        pasos += `<b>3Ô∏è‚É£ Simplificamos el numerador:</b><br>`;
        pasos += `\\[
        ${numerador.toString()}
        \\]<br><br>`;

        // Paso 4: Dividir entre h
        const cociente = math.simplify(`(${numerador}) / h`);
        pasos += `<b>4Ô∏è‚É£ Dividimos todo entre h:</b><br>`;
        pasos += `\\[
        ${cociente.toString()}
        \\]<br><br>`;

        // Paso 5: Aplicar l√≠mite h->0
        const derivada = math.simplify(cociente.toString().replace(/h/g, "0"));
        pasos += `<b>5Ô∏è‚É£ L√≠mite cuando h ‚Üí 0:</b><br>`;
        pasos += `\\[
        f'(x) = ${derivada.toString()}
        \\]<br><br>`;

        document.getElementById("explicacion").innerHTML = pasos;
        MathJax.typeset();

        // --- Ejemplo num√©rico ---
        let tabla = `<b>üìä Ejemplo num√©rico en x‚ÇÄ = ${x0}:</b><br><table><tr><th>h</th><th>(f(x‚ÇÄ+h) - f(x‚ÇÄ))/h</th></tr>`;
        let hs = [1, 0.5, 0.1, 0.01, 0.001];
        hs.forEach(h => {
            let val = (parser.evaluate(`f(${x0}+${h})`) - parser.evaluate(`f(${x0})`)) / h;
            tabla += `<tr><td>${h}</td><td>${val.toFixed(6)}</td></tr>`;
        });
        tabla += "</table>";
        document.getElementById("tablaNumerica").innerHTML = tabla;

        // --- Gr√°fica con animaci√≥n ---
        const f = (x) => parser.evaluate(`f(${x})`);
        const df = (x) => parser.evaluate(derivada.toString().replace(/x/g, `(${x})`));

        let xs = [], ys1 = [], ys2 = [];
        for (let xi = -10; xi <= 10; xi += 0.1) {
            xs.push(xi);
            ys1.push(f(xi));
            ys2.push(df(xi));
        }

        // Puntos para secante y tangente
        let hAnim = 2; // empezamos con h grande
        let secX = [x0, x0 + hAnim];
        let secY = [f(x0), f(x0 + hAnim)];

        const trace1 = { x: xs, y: ys1, type: 'scatter', name: 'f(x)' };
        const trace2 = { x: xs, y: ys2, type: 'scatter', name: "f'(x)" };
        const secante = { x: secX, y: secY, type: 'scatter', mode: 'lines', name: 'Secante', line: { dash: 'dot', color: 'red' } };
        const punto = { x: [x0], y: [f(x0)], type: 'scatter', mode: 'markers', name: 'Punto x‚ÇÄ', marker: { size: 8, color: 'black' } };

        Plotly.newPlot('grafica', [trace1, trace2, secante, punto], {
            title: 'Funci√≥n, derivada y recta secante ‚Üí tangente',
            xaxis: { title: 'x' },
            yaxis: { title: 'Valor' }
        });

        // Animaci√≥n: reducir h
        let step = 0;
        let interval = setInterval(() => {
            if (hAnim > 0.05) {
                hAnim *= 0.7;
                secX = [x0, x0 + hAnim];
                secY = [f(x0), f(x0 + hAnim)];
                Plotly.update('grafica', { x: [xs, xs, secX, [x0]], y: [ys1, ys2, secY, [f(x0)]] });
            } else {
                clearInterval(interval);
            }
        }, 800);

    } catch (err) {
        document.getElementById("explicacion").innerHTML = `<b>Error:</b> Verifica que la funci√≥n est√© bien escrita.`;
    }
}
</script>

</body>
</html>
