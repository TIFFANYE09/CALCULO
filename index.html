<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Calculadora de Derivadas</title>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjs@11/lib/browser/math.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    input, button { padding: 10px; margin-top: 10px; width: 100%; }
    .output { margin-top: 20px; }
    #graph { width: 100%; height: 400px; }
    #contentToDownload { border: 1px solid #ccc; padding: 20px; margin-top: 20px; }
  </style>
</head>
<body>
  <h2>Calculadora de Derivadas</h2>
  <label for="funcion">Ingresa la función (ejemplo: x^2 + 3x):</label>
  <input type="text" id="funcion" placeholder="f(x) =" />

  <button onclick="resolver()">Resolver Derivada</button>
  <button onclick="descargarPDF()">Descargar Resultado</button>

  <div id="contentToDownload">
    <div class="output">
      <h3>Proceso largo (definición con límite)</h3>
      <div id="procesoLargo"></div>

      <h3>Proceso corto (regla de derivación)</h3>
      <div id="procesoCorto"></div>

      <h3>Fórmula General (si aplica)</h3>
      <div id="formulaGeneral"></div>

      <h3>Gráfica de f(x) y f'(x)</h3>
      <div id="graph"></div>
    </div>
  </div>

  <script>
    function resolver() {
      const expr = document.getElementById("funcion").value;
      const scope = { x: 1 };

      try {
        // Derivada con math.js
        const derivada = math.derivative(expr, 'x').toString();

        // Proceso largo (definición del límite)
        const procesoLargo = `
        \\[
          f'(x) = \\lim_{h \\to 0} \\frac{f(x+h) - f(x)}{h} = 
          \\lim_{h \\to 0} \\frac{(${expr.replace(/x/g, '(x+h)')}) - (${expr})}{h}
        \\]
        `;

        // Proceso corto (simplificado)
        const procesoCorto = `
        \\[
          f'(x) = ${math.simplify(derivada).toTex()}
        \\]
        `;

        // Fórmula general (ejemplo si es potencia)
        let formulaGeneral = "";
        if (/x\^\d/.test(expr)) {
          formulaGeneral = `
          \\[
            \\text{Regla de la potencia: } \\frac{d}{dx}(x^n) = nx^{n-1}
          \\]`;
        }

        // Mostrar resultados
        document.getElementById("procesoLargo").innerHTML = procesoLargo;
        document.getElementById("procesoCorto").innerHTML = procesoCorto;
        document.getElementById("formulaGeneral").innerHTML = formulaGeneral;
        MathJax.typeset();

        // Gráfica
        graficar(expr, derivada);
      } catch (err) {
        alert("Error en la función. Revisa la sintaxis.");
      }
    }

    function graficar(funcion, derivada) {
      const x = math.range(-10, 10, 0.5).toArray();
      const f = x.map(val => math.evaluate(funcion, { x: val }));
      const df = x.map(val => math.evaluate(derivada, { x: val }));

      const data = [
        {
          x, y: f, mode: 'lines', name: 'f(x)'
        },
        {
          x, y: df, mode: 'lines', name: "f'(x)"
        }
      ];

      Plotly.newPlot('graph', data, {
        margin: { t: 0 }, xaxis: { title: 'x' }, yaxis: { title: 'y' }
      });
    }

    function descargarPDF() {
      const element = document.getElementById("contentToDownload");
      html2pdf().from(element).save("resultado_derivada.pdf");
    }
  </script>
</body>
</html>
